# Efficient DNN Implementation on FPGA

The objective of this project is to optimize a pretrained deep neural network model by quantization and implement it on a Xilinx PYNQ-Z2 board using the FINN Framework.

## Requirements

* Ubuntu 20.04 for FINN Compiler (other versions may work but are not tested).
* PYNQ-Z2 board with PYNQ v2.6 image (other versions may work but are not tested).
* Vivado 2022.1 (2020.1 or below for Vitis-HLS - Not working on 2021.1 and 2021.2 for some reason).
* GPU training-time acceleration (*Optional* but recommended).


## Training DNN

We want to  train our own quantized neural network (QNN) using the Brevitas library, which supports quantization-aware training (QAT). This will involve experimenting with various quantization levels to find out the most energy-efficient model. Once the QNN model has been trained, it must be exported to FINN-ONNX format, which is a format compatible with the FINN Framework.

### Prerequisites
Brevitas library can be installed by running the following command:

```bash
pip install brevitas
```

### Training the QNN

The model is located in ```training/model.py```. The training notebook is located in ```training/train.ipynb``` and can be used to train 1W1A up to 3W3A QNNs. The notebook also contains the code to export the trained model to ONNX format. The exported model is located in ```training/models/model_xWxA.onnx```.


## Generate the bitstream

### Installing docker

Run the following commands to install docker:

```bash
chmod +x docker_install.sh
./docker_install.sh
```

You can test your docker installation by running the ```hello-world``` container:

```bash
docker run --rm hello-world
```

The ```--rm``` flag tells docker to remove the container once it's done. Your output should look like:

```bash
Hello from Docker!
This message shows that your installation appears to be working correctly.
```

### Setting up the FINN docker container

Modify ```FINN_XILINX_PATH```, ```FINN_XILINX_VERSION``` and ```VIVADO_PATH``` environment variables pointing to your Xilinx installation path and Vivado installation path in ```env_finn.sh```.
Then run the following commands to set up the FINN docker container:

```bash
source env_finn.sh
```

### Verifying the FINN installation

Clone the FINN compiler from the repository: ```git clone https://github.com/Xilinx/finn/``` and go into the directory: ```cd finn```.

If everything is set up correctly, you can now run the following command to open jupyter notebook:

```bash
./run-docker.sh notebook
```

This will launch the Jupyter notebook server inside a Docker container, and print a link on the terminal that you can open in your browser to run the FINN notebooks or create new ones. The link will look something like this (the token you get will be different): ```http://127.0.0.1:8888/?token=1dbc348eff2e275f9fdc9e61d9e9564fe5cf8e0d259a8642```. Open it in your browser and you are ready to go.

### Generate bitstream and deployment package for PYNQ

Run the custom build dataflow (same as the one in cybersecurity notebook) with the correct onnx model and with a target fps that is achieveable for the PYNQ board (check resources constraints of the board). The deployment package that contains the bitstream and all the hardware files can now be generated by the builder.

## Deploying the bitstream on the PYNQ board

First, set up the PYNQ board by following the instructions in the [PYNQ documentation](https://pynq.readthedocs.io/en/v2.6.0/getting_started/setup_board.html). Then you can transfer the deployment package to the board using ```scp```, as well as the validation notebook available in the ```pynq``` directory:

```bash
scp deploy-on-pynq_xwxa.zip xilinx@<pynq_board_ip>:
scp pynq/validate.ipynb xilinx@<pynq_board_ip>:/home/xilinx/jupyter_notebooks
```

Then, on the PYNQ board, run the following commands to unzip the deployment package and install the bitstream:

```bash
unzip deploy-on-pynq_xwxa.zip
```

Finally, you can run the ```validation.ipynb``` notebook to test the bitstream on the PYNQ board with the CIFAR-10 dataset.
